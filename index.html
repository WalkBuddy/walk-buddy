<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walk Buddy</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #8FAF8C; --bg: #F7F3EC; --dark: #3D2B1F;
    --mid: #D4C5A9; --accent: #7BADC4; --warm: #E8D5B7;
    --card: #ffffff; --text-sub: #7a6355; --text-muted: #9a8878;
  }
  [data-theme="ocean"] {
    --primary: #5B9EC9; --bg: #EEF5FA; --dark: #1A3A4A;
    --mid: #B8D4E8; --accent: #F4A261; --warm: #D6EAF5;
    --card: #ffffff; --text-sub: #3a6070; --text-muted: #7a9aaa;
  }
  [data-theme="city"] {
    --primary: #A0A0A0; --bg: #1A1A1A; --dark: #F0F0F0;
    --mid: #333333; --accent: #E8C547; --warm: #2A2A2A;
    --card: #242424; --text-sub: #A0A0A0; --text-muted: #707070;
  }
  [data-theme="bloom"] {
    --primary: #C77DBA; --bg: #FDF0F8; --dark: #3D1A35;
    --mid: #E8C5DF; --accent: #F4A261; --warm: #F5E0F0;
    --card: #ffffff; --text-sub: #7a3a6a; --text-muted: #9a6a8a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--dark); min-height: 100vh; overflow-x: hidden; transition: background 0.4s, color 0.4s; }
  body::before { content:''; position:fixed; top:-120px; right:-120px; width:400px; height:400px; border-radius:50%; background:radial-gradient(circle, var(--primary) 0%, transparent 70%); opacity:0.2; pointer-events:none; }
  body::after  { content:''; position:fixed; bottom:-80px; left:-80px; width:300px; height:300px; border-radius:50%; background:radial-gradient(circle, var(--accent) 0%, transparent 70%); opacity:0.15; pointer-events:none; }

  header { padding:1.25rem 1rem 0.25rem; text-align:center; animation:fadeDown 0.7s ease both; position:relative; }
  .logo { font-family:'DM Serif Display',serif; font-size:2.4rem; color:var(--dark); letter-spacing:-0.5px; }
  .logo span { color:var(--primary); font-style:italic; }
  .tagline { font-size:0.78rem; font-weight:300; color:var(--text-sub); margin-top:0.2rem; letter-spacing:0.08em; text-transform:uppercase; }

  /* Smaller theme dropdown */
  .theme-dropdown-wrap { position:absolute; top:1rem; right:0.75rem; z-index:100; }
  .theme-select { appearance:none; -webkit-appearance:none; background:var(--card); color:var(--dark); border:1.5px solid var(--mid); border-radius:100px; padding:0.25rem 1.6rem 0.25rem 0.6rem; font-size:0.7rem; font-family:'DM Sans',sans-serif; font-weight:500; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.07); background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%23888' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 0.5rem center; transition:border-color 0.2s; }
  .theme-select:focus { outline:none; border-color:var(--primary); }

  .top-bar { display:flex; justify-content:center; gap:0.5rem; padding:0.4rem 1rem 0.5rem; max-width:480px; margin:0 auto; }
  .top-pill { display:flex; align-items:center; gap:0.35rem; background:var(--card); border-radius:100px; padding:0.35rem 0.75rem; font-size:0.78rem; font-weight:500; color:var(--dark); box-shadow:0 2px 10px rgba(0,0,0,0.07); transition:background 0.4s,color 0.4s; }
  .top-pill .pill-sub { font-size:0.64rem; color:var(--text-muted); font-weight:400; }
  .streak-pill.active { background:var(--dark); color:var(--bg); }
  .streak-pill.active .pill-sub { color:var(--mid); }

  .card { background:var(--card); border-radius:20px; padding:1.5rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 24px rgba(0,0,0,0.06); transition:background 0.4s; }
  .section-label { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.12em; color:var(--primary); margin-bottom:0.65rem; }

  .distance-display { font-family:'DM Serif Display',serif; font-size:3rem; color:var(--dark); line-height:1; margin-bottom:0.2rem; }
  .distance-display span { font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:300; color:var(--text-sub); }

  input[type=range] { -webkit-appearance:none; width:100%; height:6px; border-radius:3px; background:linear-gradient(to right, var(--primary) 0%, var(--primary) var(--pct,30%), var(--mid) var(--pct,30%), var(--mid) 100%); margin:0.8rem 0 0.35rem; outline:none; cursor:pointer; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:var(--dark); border:3px solid var(--card); box-shadow:0 2px 8px rgba(0,0,0,0.2); transition:transform 0.15s; }
  input[type=range]::-webkit-slider-thumb:active { transform:scale(1.2); }
  .range-labels { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-muted); }

  .prefs-grid { display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.35rem; }
  .pref-chip { display:flex; align-items:center; gap:0.35rem; padding:0.4rem 0.85rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; cursor:pointer; font-size:0.8rem; font-family:'DM Sans',sans-serif; color:var(--dark); transition:all 0.18s; -webkit-tap-highlight-color:transparent; }
  .pref-chip:active { transform:scale(0.96); }
  .pref-chip.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }
  .pref-chip .icon { font-size:0.9rem; }

  .generate-btn { width:100%; padding:0.9rem; border-radius:14px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.15rem; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-top:1.1rem; -webkit-tap-highlight-color:transparent; }
  .generate-btn:active { opacity:0.85; transform:scale(0.98); }

  #map-section { max-width:480px; margin:0 auto 0.5rem; display:none; padding:0 0.5rem; }
  #map { width:100%; height:320px; border-radius:18px; overflow:hidden; box-shadow:0 4px 24px rgba(0,0,0,0.1); }

  .route-info { display:flex; gap:0.5rem; margin-top:0.6rem; }
  .info-pill { flex:1; background:var(--card); border-radius:12px; padding:0.7rem 0.5rem; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .info-pill .val { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--dark); }
  .info-pill .lbl { font-size:0.64rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); margin-top:0.1rem; }

  .spots-list { background:var(--card); border-radius:14px; padding:1rem; margin-top:0.6rem; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .spots-title { font-size:0.7rem; font-weight:500; text-transform:uppercase; letter-spacing:0.1em; color:var(--primary); margin-bottom:0.65rem; }
  .spot-item { display:flex; align-items:center; gap:0.65rem; padding:0.4rem 0; border-bottom:1px solid var(--warm); font-size:0.85rem; color:var(--dark); }
  .spot-item:last-child { border-bottom:none; }
  .spot-icon { width:28px; height:28px; border-radius:7px; background:var(--warm); display:flex; align-items:center; justify-content:center; font-size:0.9rem; flex-shrink:0; }
  .spot-name { font-weight:500; }
  .spot-type { font-size:0.72rem; color:var(--text-muted); }

  /* Ready to walk */
  .ready-card { background:var(--card); border-radius:20px; padding:1.4rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 20px rgba(0,0,0,0.06); text-align:center; display:none; }
  .ready-title { font-family:'DM Serif Display',serif; font-size:1.5rem; color:var(--dark); margin-bottom:0.35rem; }
  .ready-sub { font-size:0.82rem; color:var(--text-muted); margin-bottom:1.1rem; }
  .ready-btns { display:flex; gap:0.65rem; }
  .ready-yes { flex:1; padding:0.8rem; border-radius:12px; border:none; background:var(--dark); color:var(--bg); font-family:'DM Serif Display',serif; font-size:1.05rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .ready-yes:active { opacity:0.85; }
  .ready-no { flex:1; padding:0.8rem; border-radius:12px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.88rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }

  /* Walking mode */
  .walking-card { background:var(--dark); color:var(--bg); border-radius:20px; padding:1.4rem; margin:0.5rem auto; max-width:480px; box-shadow:0 4px 20px rgba(0,0,0,0.15); display:none; }
  .walking-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.85rem; }
  .walking-title { font-family:'DM Serif Display',serif; font-size:1.25rem; }
  .walking-timer { font-size:0.82rem; opacity:0.65; font-variant-numeric:tabular-nums; }
  .walk-progress-wrap { background:rgba(255,255,255,0.15); border-radius:100px; height:7px; margin-bottom:0.85rem; overflow:hidden; }
  .walk-progress-bar { height:100%; border-radius:100px; background:var(--primary); transition:width 0.8s ease; width:0%; }
  .walk-stats { display:flex; gap:0.6rem; margin-bottom:0.85rem; }
  .ws { flex:1; background:rgba(255,255,255,0.1); border-radius:11px; padding:0.65rem 0.4rem; text-align:center; }
  .ws .wv { font-family:'DM Serif Display',serif; font-size:1.3rem; }
  .ws .wl { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em; opacity:0.55; margin-top:0.1rem; }
  .direction-box { background:rgba(255,255,255,0.08); border-radius:11px; padding:0.8rem; margin-bottom:0.85rem; min-height:60px; }
  .dir-step { font-size:0.9rem; font-weight:500; line-height:1.4; }
  .dir-dist { font-size:0.75rem; opacity:0.55; margin-top:0.25rem; }

  /* Walk action buttons */
  .walk-actions { display:flex; gap:0.6rem; margin-bottom:0.6rem; }
  .pause-btn { flex:1; padding:0.75rem; border-radius:11px; border:1.5px solid rgba(255,255,255,0.25); background:transparent; color:var(--bg); font-family:'DM Sans',sans-serif; font-size:0.88rem; cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all 0.18s; }
  .pause-btn:active { background:rgba(255,255,255,0.1); }
  .cancel-btn { flex:1; padding:0.75rem; border-radius:11px; border:1.5px solid rgba(255,100,100,0.4); background:transparent; color:#ff8888; font-family:'DM Sans',sans-serif; font-size:0.88rem; cursor:pointer; -webkit-tap-highlight-color:transparent; }
  .cancel-btn:active { background:rgba(255,100,100,0.1); }

  .complete-btn { width:100%; padding:0.8rem; border-radius:11px; border:none; background:var(--primary); color:var(--dark); font-family:'DM Serif Display',serif; font-size:1.05rem; cursor:pointer; opacity:0.35; transition:all 0.3s; -webkit-tap-highlight-color:transparent; }
  .complete-btn.unlocked { opacity:1; }
  .complete-btn.unlocked:active { transform:scale(0.97); }
  .complete-hint { font-size:0.7rem; opacity:0.45; text-align:center; margin-top:0.4rem; }

  /* Streak banner */
  .streak-banner { background:var(--dark); color:var(--bg); border-radius:16px; padding:1rem 1.2rem; margin:0.5rem auto; max-width:480px; text-align:center; display:none; box-shadow:0 4px 16px rgba(0,0,0,0.12); }
  .streak-num { font-family:'DM Serif Display',serif; font-size:1.6rem; }
  .streak-msg { font-size:0.78rem; color:var(--mid); margin-top:0.2rem; }

  /* Stats */
  .stats-card { margin-bottom:1.5rem; }
  .stats-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.9rem; }
  .stats-tabs { display:flex; gap:0.35rem; }
  .stats-tab { padding:0.28rem 0.7rem; border-radius:100px; border:1.5px solid var(--mid); background:transparent; font-size:0.72rem; font-family:'DM Sans',sans-serif; color:var(--dark); cursor:pointer; transition:all 0.18s; -webkit-tap-highlight-color:transparent; }
  .stats-tab.active { background:var(--dark); border-color:var(--dark); color:var(--bg); }

  .stats-big { display:flex; gap:0.5rem; margin-bottom:0.6rem; }
  .sbb { flex:1; background:var(--warm); border-radius:14px; padding:0.9rem 0.7rem; text-align:center; }
  .sbb .sv { font-family:'DM Serif Display',serif; font-size:1.8rem; color:var(--dark); line-height:1; }
  .sbb .sl { font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.25rem; }
  .stats-small { display:flex; gap:0.5rem; }
  .ssb { flex:1; background:var(--warm); border-radius:11px; padding:0.65rem 0.5rem; text-align:center; }
  .ssb .sv { font-family:'DM Serif Display',serif; font-size:1.2rem; color:var(--dark); }
  .ssb .sl { font-size:0.6rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); margin-top:0.1rem; }
  .month-history { margin-top:0.7rem; }
  .month-row { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--warm); }
  .month-row:last-child { border-bottom:none; }
  .month-name { font-weight:500; font-size:0.85rem; }
  .month-right { text-align:right; }
  .month-miles { font-family:'DM Serif Display',serif; font-size:0.95rem; }
  .month-detail { font-size:0.7rem; color:var(--text-muted); }
  .stats-empty { text-align:center; color:var(--text-muted); padding:1.5rem 0; font-size:0.82rem; }

  .new-route-btn { width:100%; padding:0.75rem; border-radius:11px; border:1.5px solid var(--mid); background:transparent; color:var(--dark); font-family:'DM Sans',sans-serif; font-size:0.86rem; cursor:pointer; margin-top:0.6rem; display:block; max-width:480px; margin-left:auto; margin-right:auto; -webkit-tap-highlight-color:transparent; }
  .new-route-btn:active { background:rgba(0,0,0,0.04); }

  .card.loading-state { text-align:center; padding:2rem; display:none; }
  .walk-anim { font-size:2rem; animation:walkstep 0.6s steps(2) infinite; display:inline-block; }
  @keyframes walkstep { 0%{transform:translateX(-4px)} 100%{transform:translateX(4px)} }
  .loading-text { font-family:'DM Serif Display',serif; font-size:1.05rem; color:var(--dark); margin-top:0.7rem; }
  .loading-sub { font-size:0.8rem; color:var(--text-muted); margin-top:0.2rem; }

  @keyframes fadeDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
  @keyframes fadeUp   { from{opacity:0;transform:translateY(12px)}  to{opacity:1;transform:translateY(0)} }

  /* Mobile padding */
  @media (max-width: 500px) {
    .card, #map-section, .ready-card, .walking-card, .streak-banner { margin-left:0.5rem; margin-right:0.5rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Walk <span>Buddy</span></div>
  <div class="tagline" id="tagline">Detecting your location‚Ä¶</div>
  <div class="theme-dropdown-wrap">
    <select class="theme-select" id="theme-select" onchange="setTheme(this.value)">
      <option value="forest">üåø Forest</option>
      <option value="ocean">üåä Ocean</option>
      <option value="city">üåÜ City</option>
      <option value="bloom">üå∏ Bloom</option>
    </select>
  </div>
</header>

<div class="top-bar">
  <div class="top-pill" id="weather-pill">
    <span class="pill-icon">üå§Ô∏è</span>
    <span id="weather-text">‚Äî</span>
  </div>
  <div class="top-pill streak-pill" id="streak-pill">
    <span class="pill-icon">üî•</span>
    <div>
      <div id="streak-text">0 day streak</div>
      <div class="pill-sub" id="streak-sub">Go on a walk to start!</div>
    </div>
  </div>
</div>

<!-- Planner -->
<div class="card" id="planner-card">
  <div class="section-label">How far do you want to walk?</div>
  <div class="distance-display" id="dist-display">1.5 <span>miles</span></div>
  <input type="range" id="dist-slider" min="0.5" max="5" step="0.5" value="1.5">
  <div class="range-labels"><span>0.5 mi</span><span>5 mi</span></div>
  <div style="margin-top:1.2rem">
    <div class="section-label">What do you want to pass by?</div>
    <div class="prefs-grid">
      <button class="pref-chip" data-pref="park"       onclick="togglePref(this)"><span class="icon">üå≥</span> Park</button>
      <button class="pref-chip" data-pref="coffee"     onclick="togglePref(this)"><span class="icon">‚òï</span> Coffee</button>
      <button class="pref-chip" data-pref="bookstore"  onclick="togglePref(this)"><span class="icon">üìö</span> Bookstore</button>
      <button class="pref-chip" data-pref="shops"      onclick="togglePref(this)"><span class="icon">üõçÔ∏è</span> Shops</button>
      <button class="pref-chip" data-pref="restaurant" onclick="togglePref(this)"><span class="icon">üçú</span> Restaurant</button>
      <button class="pref-chip" data-pref="nature"     onclick="togglePref(this)"><span class="icon">üåø</span> Nature</button>
      <button class="pref-chip" data-pref="art"        onclick="togglePref(this)"><span class="icon">üé®</span> Art / Murals</button>
      <button class="pref-chip" data-pref="water"      onclick="togglePref(this)"><span class="icon">üåä</span> Water</button>
      <button class="pref-chip" data-pref="quiet"      onclick="togglePref(this)"><span class="icon">ü§´</span> Quiet streets</button>
    </div>
  </div>
  <button class="generate-btn" onclick="generateRoute()">üó∫Ô∏è Generate My Walk</button>
</div>

<!-- Loading -->
<div class="card loading-state" id="loading-card">
  <div class="walk-anim">üö∂</div>
  <div class="loading-text">Finding your route‚Ä¶</div>
  <div class="loading-sub">Discovering spots along the way</div>
</div>

<!-- Map -->
<div id="map-section">
  <div id="map"></div>
  <div class="route-info" id="route-info"></div>
  <div class="spots-list" id="spots-list" style="display:none"></div>
</div>

<!-- Ready to walk -->
<div class="ready-card" id="ready-card">
  <div class="ready-title">Ready to walk? üö∂</div>
  <div class="ready-sub" id="ready-sub">Your route is set. Let's go!</div>
  <div class="ready-btns">
    <button class="ready-yes" onclick="startWalking()">Yes, let's go!</button>
    <button class="ready-no"  onclick="resetPlanner()">Not now</button>
  </div>
</div>

<!-- Walking mode -->
<div class="walking-card" id="walking-card">
  <div class="walking-top">
    <div class="walking-title">üö∂ Walking‚Ä¶</div>
    <div class="walking-timer" id="walk-timer">0:00</div>
  </div>
  <div class="walk-progress-wrap">
    <div class="walk-progress-bar" id="walk-progress"></div>
  </div>
  <div class="walk-stats">
    <div class="ws"><div class="wv" id="w-dist">0.00</div><div class="wl">Miles</div></div>
    <div class="ws"><div class="wv" id="w-steps">0</div><div class="wl">Steps</div></div>
    <div class="ws"><div class="wv" id="w-pct">0%</div><div class="wl">Done</div></div>
  </div>
  <div class="direction-box">
    <div class="dir-step" id="dir-step">Head out and follow the route on the map</div>
    <div class="dir-dist" id="dir-dist"></div>
  </div>
  <div class="walk-actions">
    <button class="pause-btn" id="pause-btn" onclick="togglePause()">‚è∏ Pause</button>
    <button class="cancel-btn" onclick="cancelWalk()">‚úï Cancel Walk</button>
  </div>
  <button class="complete-btn" id="complete-btn" onclick="completeWalk()" disabled>Complete Walk ‚úÖ</button>
  <div class="complete-hint" id="complete-hint">Walk 65% of your route to unlock</div>
</div>

<!-- Streak banner -->
<div class="streak-banner" id="streak-banner">
  <div class="streak-num" id="streak-banner-num"></div>
  <div class="streak-msg" id="streak-banner-msg"></div>
</div>

<!-- Stats -->
<div class="card stats-card" id="stats-card">
  <div class="stats-header">
    <div class="section-label" style="margin:0">Your Stats</div>
    <div class="stats-tabs">
      <button class="stats-tab active" onclick="showStats('month',this)">Month</button>
      <button class="stats-tab" onclick="showStats('year',this)">Year</button>
      <button class="stats-tab" onclick="showStats('history',this)">History</button>
    </div>
  </div>
  <div id="stats-content"></div>
</div>

<script>
const WEHOLOCENTER = {lat:34.0900,lng:-118.3617};
let userCenter = null;
let map, directionsService, directionsRenderer, placesService;
let actualRouteMiles = 0;
let requestedMiles = 1.5;
let allSteps = [];
let currentStepIndex = 0;
const selectedPrefs = new Set();

// Walk state
let walkDistanceMiles = 0;
let walkStartTime = null;
let walkTimerInterval = null;
let geoWatchId = null;
let lastGeoPos = null;
let isPaused = false;
let walkUnlocked = false;

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(t) {
  document.body.setAttribute('data-theme', t==='forest'?'':t);
  try{localStorage.setItem('wb_theme',t);}catch(e){}
}
(function(){
  try{
    const t=localStorage.getItem('wb_theme')||'forest';
    document.body.setAttribute('data-theme',t==='forest'?'':t);
    const s=document.getElementById('theme-select');
    if(s)s.value=t;
  }catch(e){}
})();

// ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStreak(){try{return JSON.parse(localStorage.getItem('wb_streak')||'{"count":0,"lastWalk":null}');}catch(e){return{count:0,lastWalk:null};}}
function recordWalk(){
  const today=new Date().toDateString();
  const d=getStreak();
  if(d.lastWalk===today)return d.count;
  const yesterday=new Date(Date.now()-86400000).toDateString();
  d.count=d.lastWalk===yesterday?d.count+1:1;
  d.lastWalk=today;
  try{localStorage.setItem('wb_streak',JSON.stringify(d));}catch(e){}
  return d.count;
}
function updateStreakUI(){
  const d=getStreak();
  document.getElementById('streak-text').textContent=`${d.count} day streak`;
  const pill=document.getElementById('streak-pill');
  const sub=document.getElementById('streak-sub');
  if(d.count>=1){
    sub.textContent=d.count>=7?'üèÜ 7 day goal reached!':`${7-(d.count%7)} days to next milestone`;
    pill.classList.add('active');
  }else{
    sub.textContent='Go on a walk to start!';
    pill.classList.remove('active');
  }
}

// ‚îÄ‚îÄ WALK LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWalkLog(){try{return JSON.parse(localStorage.getItem('wb_walklog')||'[]');}catch(e){return[];}}
function logWalkStats(miles){
  const log=getWalkLog();
  const now=new Date();
  log.push({date:now.toISOString(),miles:parseFloat(miles),steps:Math.round(miles*2000),month:now.getMonth(),year:now.getFullYear()});
  try{localStorage.setItem('wb_walklog',JSON.stringify(log));}catch(e){}
}
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
function showStats(view,btn){
  document.querySelectorAll('.stats-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const log=getWalkLog();
  const now=new Date();
  const c=document.getElementById('stats-content');
  if(view==='month'){
    const w=log.filter(x=>x.month===now.getMonth()&&x.year===now.getFullYear());
    const miles=w.reduce((a,x)=>a+x.miles,0).toFixed(1);
    const steps=w.reduce((a,x)=>a+x.steps,0);
    c.innerHTML=`<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${MONTHS[now.getMonth()]} ${now.getFullYear()}</div>
    <div class="stats-big">
      <div class="sbb"><div class="sv">${miles}</div><div class="sl">Miles this month</div></div>
      <div class="sbb"><div class="sv">${w.length}</div><div class="sl">Walks this month</div></div>
    </div>
    <div class="stats-small" style="margin-top:0.5rem">
      <div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div>
      <div class="ssb"><div class="sv">${w.length>0?(miles/w.length).toFixed(1):'‚Äî'}</div><div class="sl">Avg mi/walk</div></div>
    </div>`;
  }else if(view==='year'){
    const w=log.filter(x=>x.year===now.getFullYear());
    const miles=w.reduce((a,x)=>a+x.miles,0).toFixed(1);
    const steps=w.reduce((a,x)=>a+x.steps,0);
    c.innerHTML=`<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.65rem">${now.getFullYear()} Total</div>
    <div class="stats-big">
      <div class="sbb"><div class="sv">${miles}</div><div class="sl">Miles this year</div></div>
      <div class="sbb"><div class="sv">${w.length}</div><div class="sl">Total walks</div></div>
    </div>
    <div class="stats-small" style="margin-top:0.5rem">
      <div class="ssb"><div class="sv">${steps.toLocaleString()}</div><div class="sl">Steps</div></div>
      <div class="ssb"><div class="sv">${w.length>0?(miles/w.length).toFixed(1):'‚Äî'}</div><div class="sl">Avg mi/walk</div></div>
    </div>`;
  }else{
    const grouped={};
    log.forEach(x=>{const k=`${x.year}-${x.month}`;if(!grouped[k])grouped[k]={month:x.month,year:x.year,miles:0,steps:0,walks:0};grouped[k].miles+=x.miles;grouped[k].steps+=x.steps;grouped[k].walks++;});
    const sorted=Object.values(grouped).sort((a,b)=>b.year-a.year||b.month-a.month);
    c.innerHTML=sorted.length===0?`<div class="stats-empty">No walks yet ‚Äî go explore! üó∫Ô∏è</div>`
      :`<div class="month-history">${sorted.map(g=>`<div class="month-row"><div class="month-name">${MONTHS[g.month]} ${g.year}</div><div class="month-right"><div class="month-miles">${g.miles.toFixed(1)} mi</div><div class="month-detail">${g.walks} walks ¬∑ ${g.steps.toLocaleString()} steps</div></div></div>`).join('')}</div>`;
  }
}

// ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWeather(lat,lng){
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&temperature_unit=fahrenheit`);
    const d=await r.json();
    document.getElementById('weather-pill').querySelector('.pill-icon').textContent=weatherIcon(d.current_weather.weathercode);
    document.getElementById('weather-text').textContent=`${Math.round(d.current_weather.temperature)}¬∞F`;
  }catch(e){}
}
function weatherIcon(c){if(c===0)return'‚òÄÔ∏è';if(c<=2)return'üå§Ô∏è';if(c===3)return'‚òÅÔ∏è';if(c<=49)return'üå´Ô∏è';if(c<=67)return'üåßÔ∏è';if(c<=77)return'‚ùÑÔ∏è';if(c<=82)return'üå¶Ô∏è';return'‚õàÔ∏è';}

// ‚îÄ‚îÄ CITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function detectCity(lat,lng){
  try{
    // Use Google Geocoding instead of Nominatim to avoid CORS
    const gc=new google.maps.Geocoder();
    gc.geocode({location:{lat,lng}},(results,status)=>{
      if(status==='OK'&&results.length>0){
        const addr=results[0].address_components;
        const city=addr.find(a=>a.types.includes('locality'))||addr.find(a=>a.types.includes('sublocality'))||addr.find(a=>a.types.includes('administrative_area_level_2'));
        if(city)document.getElementById('tagline').textContent=`${city.long_name} ¬∑ Discover your neighborhood`;
        else document.getElementById('tagline').textContent='Discover your neighborhood';
      }
    });
  }catch(e){document.getElementById('tagline').textContent='Discover your neighborhood';}
}

// ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePref(el){
  const p=el.dataset.pref;
  if(selectedPrefs.has(p)){selectedPrefs.delete(p);el.classList.remove('active');}
  else{selectedPrefs.add(p);el.classList.add('active');}
}
const prefToType={park:'park',coffee:'cafe',bookstore:'book_store',shops:'clothing_store',restaurant:'restaurant',nature:'park',art:'art_gallery',water:'natural_feature',quiet:null};
const prefEmoji={park:'üå≥',coffee:'‚òï',bookstore:'üìö',shops:'üõçÔ∏è',restaurant:'üçú',nature:'üåø',art:'üé®',water:'üåä',quiet:'ü§´'};

// ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const slider=document.getElementById('dist-slider');
const display=document.getElementById('dist-display');
slider.addEventListener('input',()=>{
  display.innerHTML=`${slider.value} <span>miles</span>`;
  slider.style.setProperty('--pct',((slider.value-slider.min)/(slider.max-slider.min))*100+'%');
});
slider.style.setProperty('--pct','22.2%');

// ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap(){
  map=new google.maps.Map(document.getElementById('map'),{
    center:WEHOLOCENTER,zoom:14,
    styles:[
      {featureType:'all',elementType:'geometry',stylers:[{color:'#f5efe6'}]},
      {featureType:'road',elementType:'geometry',stylers:[{color:'#ede0cc'}]},
      {featureType:'road.arterial',elementType:'geometry',stylers:[{color:'#d4c5a9'}]},
      {featureType:'water',elementType:'geometry',stylers:[{color:'#a8cfe0'}]},
      {featureType:'poi.park',elementType:'geometry',stylers:[{color:'#c8dfc4'}]},
      {featureType:'poi',elementType:'labels',stylers:[{visibility:'off'}]},
      {featureType:'transit',stylers:[{visibility:'off'}]},
    ],
    disableDefaultUI:true,zoomControl:true,gestureHandling:'greedy',
  });
  directionsService=new google.maps.DirectionsService();
  directionsRenderer=new google.maps.DirectionsRenderer({
    polylineOptions:{strokeColor:'#3D2B1F',strokeWeight:4,strokeOpacity:0.85},
    suppressMarkers:false,
  });
  directionsRenderer.setMap(map);
  placesService=new google.maps.places.PlacesService(map);

  updateStreakUI();
  showStats('month',document.querySelector('.stats-tab.active'));

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        userCenter={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.setCenter(userCenter);
        new google.maps.Marker({position:userCenter,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:'#7BADC4',fillOpacity:1,strokeColor:'white',strokeWeight:2},title:'You are here'});
        detectCity(userCenter.lat,userCenter.lng);
        fetchWeather(userCenter.lat,userCenter.lng);
      },
      ()=>{document.getElementById('tagline').textContent='West Hollywood ¬∑ Discover your neighborhood';fetchWeather(WEHOLOCENTER.lat,WEHOLOCENTER.lng);}
    );
  }else{
    document.getElementById('tagline').textContent='West Hollywood ¬∑ Discover your neighborhood';
    fetchWeather(WEHOLOCENTER.lat,WEHOLOCENTER.lng);
  }
}

// ‚îÄ‚îÄ HAVERSINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1,lng1,lat2,lng2){
  const R=3958.8,dL=(lat2-lat1)*Math.PI/180,dl=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ‚îÄ‚îÄ GENERATE ROUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateRoute(){
  requestedMiles=parseFloat(slider.value);
  const center=userCenter||WEHOLOCENTER;

  document.getElementById('planner-card').style.display='none';
  document.getElementById('loading-card').style.display='block';
  document.getElementById('map-section').style.display='none';
  document.getElementById('ready-card').style.display='none';
  document.getElementById('walking-card').style.display='none';
  document.getElementById('streak-banner').style.display='none';
  document.querySelectorAll('.new-route-btn').forEach(b=>b.remove());

  const waypoints=[],foundSpots=[];
  const types=[...selectedPrefs].map(p=>prefToType[p]).filter(Boolean);
  const uniqueTypes=[...new Set(types)];
  const angles=[0,90,180,270,45,135,225,315];
  let ai=0;
  const mpm=1609.34;
  const radius=(requestedMiles/4)*mpm;

  await Promise.all(uniqueTypes.slice(0,3).map((type)=>new Promise(resolve=>{
    const angle=(angles[ai++%angles.length]*Math.PI)/180;
    const oLat=center.lat+(radius/111320)*Math.sin(angle);
    const oLng=center.lng+(radius/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle);
    placesService.nearbySearch({location:{lat:oLat,lng:oLng},radius,type},(results,status)=>{
      if(status==='OK'&&results.length>0){
        const pick=results[Math.floor(Math.random()*Math.min(5,results.length))];
        waypoints.push({location:{lat:pick.geometry.location.lat(),lng:pick.geometry.location.lng()},stopover:false});
        foundSpots.push({name:pick.name,type:[...selectedPrefs].find(p=>prefToType[p]===type)});
      }
      resolve();
    });
  })));

  if(waypoints.length===0){
    const angle=Math.random()*2*Math.PI;
    const d=(requestedMiles/3.5)*mpm;
    waypoints.push({location:{lat:center.lat+(d/111320)*Math.sin(angle),lng:center.lng+(d/(111320*Math.cos(center.lat*Math.PI/180)))*Math.cos(angle)},stopover:false});
  }

  tryRoute(center,waypoints,foundSpots,requestedMiles,0);
}

function tryRoute(center,waypoints,foundSpots,targetMiles,attempt){
  directionsService.route({
    origin:center,destination:center,waypoints,
    travelMode:'WALKING',optimizeWaypoints:true,
    avoidHighways:true,avoidTolls:true,
  },(result,status)=>{
    document.getElementById('loading-card').style.display='none';
    if(status==='OK'){
      const leg=result.routes[0].legs;
      let totalDist=0,totalTime=0;
      leg.forEach(l=>{totalDist+=l.distance.value;totalTime+=l.duration.value;});
      const distMiles=totalDist/1609.34;
      const ratio=distMiles/targetMiles;

      if((ratio>1.2||ratio<0.8)&&attempt<2){
        const scale=targetMiles/distMiles;
        const adjusted=waypoints.map(wp=>({location:{lat:center.lat+(wp.location.lat-center.lat)*scale,lng:center.lng+(wp.location.lng-center.lng)*scale},stopover:false}));
        tryRoute(center,adjusted,foundSpots,targetMiles,attempt+1);
        return;
      }

      directionsRenderer.setDirections(result);
      actualRouteMiles=distMiles;

      allSteps=[];
      leg.forEach(l=>l.steps.forEach(s=>allSteps.push({instruction:s.instructions.replace(/<[^>]*>/g,''),distance:s.distance.text})));

      document.getElementById('route-info').innerHTML=`
        <div class="info-pill"><div class="val">${distMiles.toFixed(1)}</div><div class="lbl">Miles</div></div>
        <div class="info-pill"><div class="val">${Math.round(totalTime/60)}</div><div class="lbl">Est. Min</div></div>
        <div class="info-pill"><div class="val">${Math.round(distMiles*2000)}</div><div class="lbl">Est. Steps</div></div>`;

      const sl=document.getElementById('spots-list');
      if(foundSpots.length>0){
        sl.innerHTML=`<div class="spots-title">Along your route</div>${foundSpots.map(s=>`
          <div class="spot-item">
            <div class="spot-icon">${prefEmoji[s.type]||'üìç'}</div>
            <div><div class="spot-name">${s.name}</div><div class="spot-type">${s.type?s.type.charAt(0).toUpperCase()+s.type.slice(1):'Point of interest'}</div></div>
          </div>`).join('')}`;
        sl.style.display='block';
      }else{sl.style.display='none';}

      document.getElementById('map-section').style.display='block';
      document.getElementById('ready-card').style.display='block';
      document.getElementById('ready-sub').textContent=`${distMiles.toFixed(1)} mile loop ready. Let's go!`;
    }else{
      document.getElementById('map-section').style.display='block';
      document.getElementById('route-info').innerHTML=`<div class="info-pill" style="flex:1"><div class="val">üó∫Ô∏è</div><div class="lbl">Route unavailable ‚Äî try different prefs</div></div>`;
      document.getElementById('spots-list').style.display='none';
      document.getElementById('ready-card').style.display='none';
    }
  });
}

// ‚îÄ‚îÄ START WALKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startWalking(){
  document.getElementById('ready-card').style.display='none';
  document.getElementById('walking-card').style.display='block';
  walkDistanceMiles=0;
  walkStartTime=Date.now();
  isPaused=false;
  walkUnlocked=false;
  currentStepIndex=0;
  lastGeoPos=null;
  updateDirStep();

  walkTimerInterval=setInterval(()=>{
    if(isPaused)return;
    const e=Math.floor((Date.now()-walkStartTime)/1000);
    const m=Math.floor(e/60),s=e%60;
    document.getElementById('walk-timer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
  },1000);

  if(navigator.geolocation){
    geoWatchId=navigator.geolocation.watchPosition((pos)=>{
      if(isPaused)return;
      const curr={lat:pos.coords.latitude,lng:pos.coords.longitude};
      if(lastGeoPos){
        const d=haversine(lastGeoPos.lat,lastGeoPos.lng,curr.lat,curr.lng);
        if(d>0.005&&d<0.3){
          walkDistanceMiles+=d;
          updateWalkUI();
        }
      }
      lastGeoPos=curr;
    },{enableHighAccuracy:true,maximumAge:3000,timeout:15000});
  }
}

function updateDirStep(){
  if(allSteps.length===0)return;
  const s=allSteps[Math.min(currentStepIndex,allSteps.length-1)];
  document.getElementById('dir-step').textContent=s.instruction;
  document.getElementById('dir-dist').textContent=s.distance;
}

function updateWalkUI(){
  const pct=Math.min(walkDistanceMiles/actualRouteMiles,1);
  document.getElementById('w-dist').textContent=walkDistanceMiles.toFixed(2);
  document.getElementById('w-steps').textContent=Math.round(walkDistanceMiles*2000).toLocaleString();
  document.getElementById('w-pct').textContent=Math.round(pct*100)+'%';
  document.getElementById('walk-progress').style.width=Math.round(pct*100)+'%';
  const stepTarget=Math.floor(pct*allSteps.length);
  if(stepTarget>currentStepIndex){currentStepIndex=stepTarget;updateDirStep();}
  if(pct>=0.65&&!walkUnlocked){
    walkUnlocked=true;
    const btn=document.getElementById('complete-btn');
    btn.classList.add('unlocked');
    btn.disabled=false;
    document.getElementById('complete-hint').textContent="You've earned it ‚Äî tap to complete! üéâ";
  }
}

// ‚îÄ‚îÄ PAUSE / CANCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePause(){
  isPaused=!isPaused;
  document.getElementById('pause-btn').textContent=isPaused?'‚ñ∂ Resume':'‚è∏ Pause';
}

function cancelWalk(){
  stopTracking();
  document.getElementById('walking-card').style.display='none';
  document.getElementById('map-section').style.display='block';
  document.getElementById('ready-card').style.display='block';
  document.getElementById('ready-sub').textContent='Walk cancelled. Want to try again?';
}

function stopTracking(){
  if(geoWatchId!==null){navigator.geolocation.clearWatch(geoWatchId);geoWatchId=null;}
  clearInterval(walkTimerInterval);
  lastGeoPos=null;
}

// ‚îÄ‚îÄ COMPLETE WALK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function completeWalk(){
  stopTracking();
  document.getElementById('walking-card').style.display='none';

  const finalMiles=Math.max(walkDistanceMiles,actualRouteMiles*0.65);
  logWalkStats(finalMiles.toFixed(2));
  showStats('month',document.querySelector('.stats-tab.active'));

  const newStreak=recordWalk();
  updateStreakUI();

  const banner=document.getElementById('streak-banner');
  document.getElementById('streak-banner-num').textContent=`üî• ${newStreak} Day Streak!`;
  const msgs={1:"You started your streak ‚Äî come back tomorrow!",7:"üèÜ 7 days! You absolutely crushed it!"};
  document.getElementById('streak-banner-msg').textContent=msgs[newStreak]||(newStreak%7===0?`${newStreak} days strong. Incredible!`:`Keep it up ‚Äî ${7-(newStreak%7)} days to your next milestone!`);
  banner.style.display='block';

  const btn=document.createElement('button');
  btn.className='new-route-btn';
  btn.textContent='‚Ü© Plan a new walk';
  btn.onclick=resetPlanner;
  banner.insertAdjacentElement('afterend',btn);
}

function resetPlanner(){
  stopTracking();
  ['map-section','ready-card','walking-card','streak-banner'].forEach(id=>document.getElementById(id).style.display='none');
  document.querySelectorAll('.new-route-btn').forEach(b=>b.remove());
  document.getElementById('planner-card').style.display='block';
  document.getElementById('walk-progress').style.width='0%';
  document.getElementById('complete-btn').classList.remove('unlocked');
  document.getElementById('complete-btn').disabled=true;
  document.getElementById('complete-hint').textContent='Walk 65% of your route to unlock';
  document.getElementById('pause-btn').textContent='‚è∏ Pause';
  isPaused=false;
  walkUnlocked=false;
}
</script>

<!-- Replace AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc with your Google Maps API key -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-iGGcWbh7vfmVP1LC2v5qmYCBrXl4Ixc&libraries=places,geocoding&callback=initMap"></script>

</body>
</html>
